# é¢„æ£€æœºåˆ¶ä¿®å¤æ€»ç»“

## ğŸ¯ ä¿®å¤ç›®æ ‡

æ ¹æ®ç”¨æˆ·åé¦ˆçš„é—®é¢˜ï¼Œæœ¬æ¬¡ä¿®å¤ä¸»è¦è§£å†³ä»¥ä¸‹å‡ ä¸ªå…³é”®é—®é¢˜ï¼š

1. **é¢„æ£€é…ç½®ä¸ä¿å­˜**ï¼šç•Œé¢æ›´æ”¹çš„é¢„æ£€æ•°é‡ç­‰å‚æ•°ä¸ä¼šä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œå¯¼è‡´æ¯æ¬¡åˆ·æ–°éƒ½ä¼šå˜å›é»˜è®¤æ•°é‡
2. **é¢„æ£€ç»Ÿè®¡æ— æ•ˆæœ**ï¼šå‰ç«¯é¢„æ£€ç»Ÿè®¡æ²¡æœ‰èµ·ä½œç”¨ï¼Œä¼°è®¡æ˜¯é¢„æ£€å®ç°æœ‰é—®é¢˜
3. **429é”™è¯¯æ—¥å¿—è¿‡å¤š**ï¼šæ—¥å¿—ä¸­ä»æœ‰å¤§é‡429é”™è¯¯ï¼Œé¢„æ£€æœºåˆ¶ä¼¼ä¹æ²¡æœ‰èµ·åˆ°é¢„æœŸä½œç”¨

## ğŸ” é—®é¢˜åˆ†æ

### 1. é¢„æ£€é…ç½®ä¿å­˜é—®é¢˜

**æ ¹æœ¬åŸå› **ï¼š
- `KeyManager.update_precheck_config()` æ–¹æ³•åªæ›´æ–°å†…å­˜ä¸­çš„é…ç½®
- æ²¡æœ‰åŒæ­¥æ›´æ–° `Settings` å¯¹è±¡å’Œæ•°æ®åº“
- APIè·¯ç”±åªè°ƒç”¨KeyManageræ–¹æ³•ï¼Œæ²¡æœ‰æŒä¹…åŒ–é…ç½®

**å½±å“**ï¼š
- ç”¨æˆ·åœ¨ç•Œé¢ä¿®æ”¹é¢„æ£€å‚æ•°åï¼Œé‡å¯æœåŠ¡æˆ–åˆ·æ–°é¡µé¢é…ç½®ä¸¢å¤±
- æ— æ³•æŒä¹…åŒ–ç”¨æˆ·çš„ä¸ªæ€§åŒ–é¢„æ£€è®¾ç½®

### 2. é¢„æ£€ç»Ÿè®¡æ˜¾ç¤ºé—®é¢˜

**æ ¹æœ¬åŸå› **ï¼š
- `valid_keys_passed_count` è·Ÿè¸ªé€»è¾‘ä¾èµ–äº `current_batch_valid_keys` åˆ—è¡¨
- å¦‚æœåˆå§‹é¢„æ£€æ²¡æœ‰æ­£ç¡®å»ºç«‹æœ‰æ•ˆå¯†é’¥åˆ—è¡¨ï¼Œç»Ÿè®¡å°±ä¼šå¤±æ•ˆ
- ç¼ºå°‘è¶³å¤Ÿçš„è°ƒè¯•æ—¥å¿—æ¥è¯Šæ–­é—®é¢˜

**å½±å“**ï¼š
- å‰ç«¯æ˜¾ç¤ºçš„é¢„æ£€ç»Ÿè®¡æ•°æ®ä¸å‡†ç¡®
- ç”¨æˆ·æ— æ³•åˆ¤æ–­é¢„æ£€æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ

### 3. é”™è¯¯æ—¥å¿—è®°å½•é—®é¢˜

**æ ¹æœ¬åŸå› **ï¼š
- é¢„æ£€è¿‡ç¨‹ä¸­çš„keyéªŒè¯ä½¿ç”¨ä¸å®é™…APIè°ƒç”¨ç›¸åŒçš„é”™è¯¯å¤„ç†é€»è¾‘
- é¢„æ£€éªŒè¯å¤±è´¥æ—¶è®°å½•warningçº§åˆ«æ—¥å¿—ï¼Œå¢åŠ æ—¥å¿—å™ªéŸ³
- é¢„æ£€çš„ç›®çš„æ˜¯æå‰å‘ç°æ— æ•ˆkeyï¼Œå…¶è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¸åº”è¯¥ä½œä¸ºç³»ç»Ÿé”™è¯¯è®°å½•

**å½±å“**ï¼š
- æ—¥å¿—ä¸­å……æ–¥å¤§é‡é¢„æ£€è¿‡ç¨‹ä¸­çš„429ã€400é”™è¯¯
- éš¾ä»¥åŒºåˆ†çœŸæ­£çš„ç”¨æˆ·è¯·æ±‚é”™è¯¯å’Œé¢„æ£€éªŒè¯é”™è¯¯

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤é¢„æ£€é…ç½®ä¿å­˜æœºåˆ¶

**ä¿®æ”¹æ–‡ä»¶**ï¼š`app/service/key/key_manager.py`

**å…³é”®æ”¹åŠ¨**ï¼š
```python
async def update_precheck_config(self, enabled: bool = None, count: int = None, trigger_ratio: float = None):
    """æ›´æ–°é¢„æ£€é…ç½®ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œåªæ”¯æŒæ ¸å¿ƒå‚æ•°ï¼‰"""
    from app.config.config import settings
    from app.service.config.config_service import ConfigService
    
    config_changed = False
    config_updates = {}

    if enabled is not None and enabled != self.precheck_enabled:
        self.precheck_enabled = enabled
        settings.KEY_PRECHECK_ENABLED = enabled  # åŒæ­¥æ›´æ–°Settings
        config_updates["KEY_PRECHECK_ENABLED"] = enabled
        config_changed = True

    # ... å…¶ä»–å‚æ•°ç±»ä¼¼å¤„ç†

    if config_changed:
        # ä¿å­˜é…ç½®åˆ°æ•°æ®åº“
        try:
            await ConfigService.update_config(config_updates)
            logger.info(f"Precheck config saved to database: {config_updates}")
        except Exception as e:
            logger.error(f"Failed to save precheck config to database: {str(e)}")
```

**ä¿®æ”¹æ–‡ä»¶**ï¼š`app/router/gemini_routes.py`

**å…³é”®æ”¹åŠ¨**ï¼š
```python
# æ›´æ–°é…ç½®ï¼ˆåªæ›´æ–°æ ¸å¿ƒå‚æ•°ï¼‰
await key_manager.update_precheck_config(  # æ”¹ä¸ºå¼‚æ­¥è°ƒç”¨
    enabled=request.enabled,
    count=request.count,
    trigger_ratio=request.trigger_ratio
)
```

### 2. ä¼˜åŒ–é¢„æ£€æ—¥å¿—è®°å½•

**ä¿®æ”¹æ–‡ä»¶**ï¼š`app/service/key/key_manager.py`

**å…³é”®æ”¹åŠ¨**ï¼š
```python
elif response.status == 429:
    # 429é”™è¯¯ï¼Œå†·å†»å¯†é’¥ï¼ˆé¢„æ£€ä¸­ä¸è®°å½•ä¸ºwarningï¼Œé¿å…æ—¥å¿—å™ªéŸ³ï¼‰
    if settings.ENABLE_KEY_FREEZE_ON_429:
        await self.freeze_key(key)
        logger.info(f"Precheck: Key {redact_key_for_logging(key)} frozen due to 429 error")
    else:
        async with self.failure_count_lock:
            self.key_failure_counts[key] = self.MAX_FAILURES
            logger.info(f"Precheck: Key {redact_key_for_logging(key)} marked as invalid due to 429 error (freeze disabled)")
    return False
```

**æ”¹è¿›ç‚¹**ï¼š
- å°†é¢„æ£€è¿‡ç¨‹ä¸­çš„ `warning` æ—¥å¿—æ”¹ä¸º `info` çº§åˆ«
- åœ¨æ—¥å¿—æ¶ˆæ¯å‰æ·»åŠ  "Precheck:" å‰ç¼€ï¼Œä¾¿äºåŒºåˆ†
- é¢„æ£€è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¸è°ƒç”¨ `add_error_log` å‡½æ•°

### 3. å¢å¼ºé¢„æ£€ç»Ÿè®¡è°ƒè¯•

**ä¿®æ”¹æ–‡ä»¶**ï¼š`app/service/key/key_manager.py`

**å…³é”®æ”¹åŠ¨**ï¼š
```python
# æ·»åŠ è°ƒè¯•æ—¥å¿—
logger.debug(f"Precheck trigger check: position={current_absolute_position}, valid_positions={self.current_batch_valid_keys}, passed_count={self.valid_keys_passed_count}, threshold={self.valid_keys_trigger_threshold}")

# æ£€æŸ¥å½“å‰ä½ç½®æ˜¯å¦åœ¨å½“å‰æ‰¹æ¬¡çš„æœ‰æ•ˆå¯†é’¥åˆ—è¡¨ä¸­
if current_absolute_position in self.current_batch_valid_keys:
    self.valid_keys_passed_count += 1
    logger.info(f"Used valid key at position {current_absolute_position}, count: {self.valid_keys_passed_count}/{self.valid_keys_trigger_threshold}")
else:
    logger.debug(f"Key at position {current_absolute_position} not in current valid batch, not counting")
```

**æ”¹è¿›ç‚¹**ï¼š
- å¢åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œå¸®åŠ©è¯Šæ–­ç»Ÿè®¡é—®é¢˜
- å°†å…³é”®çš„ç»Ÿè®¡æ›´æ–°æ”¹ä¸º `info` çº§åˆ«ï¼Œä¾¿äºç›‘æ§

## ğŸ“Š é¢„æœŸæ•ˆæœ

### 1. é…ç½®æŒä¹…åŒ–
- âœ… ç”¨æˆ·åœ¨ç•Œé¢ä¿®æ”¹é¢„æ£€å‚æ•°åï¼Œé…ç½®ä¼šä¿å­˜åˆ°æ•°æ®åº“
- âœ… é‡å¯æœåŠ¡æˆ–åˆ·æ–°é¡µé¢åï¼Œé…ç½®ä¿æŒä¸å˜
- âœ… é…ç½®å˜æ›´ä¼šåŒæ—¶æ›´æ–°å†…å­˜ã€Settingså¯¹è±¡å’Œæ•°æ®åº“

### 2. æ—¥å¿—ä¼˜åŒ–
- âœ… é¢„æ£€è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¸å†è®°å½•ä¸ºwarningçº§åˆ«
- âœ… é¢„æ£€æ—¥å¿—å¸¦æœ‰æ˜ç¡®çš„"Precheck:"å‰ç¼€
- âœ… å‡å°‘æ—¥å¿—å™ªéŸ³ï¼Œä¾¿äºè¯†åˆ«çœŸæ­£çš„ç”¨æˆ·è¯·æ±‚é”™è¯¯

### 3. ç»Ÿè®¡æ”¹è¿›
- âœ… å¢åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºè¯Šæ–­ç»Ÿè®¡é—®é¢˜
- âœ… å…³é”®ç»Ÿè®¡æ›´æ–°ä½¿ç”¨infoçº§åˆ«ï¼Œä¾¿äºç›‘æ§
- âœ… æ›´å®¹æ˜“åˆ¤æ–­é¢„æ£€æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ

## ğŸ§ª éªŒè¯æ–¹æ³•

### è‡ªåŠ¨åŒ–éªŒè¯
è¿è¡ŒéªŒè¯è„šæœ¬ï¼š
```bash
cd gemini-balanceå¢å¼º/AITEST
python3 test_precheck_fixes.py
```

### æ‰‹åŠ¨éªŒè¯

1. **é…ç½®æŒä¹…åŒ–éªŒè¯**ï¼š
   - è®¿é—®å¯†é’¥ç®¡ç†é¡µé¢
   - ä¿®æ”¹é¢„æ£€æ•°é‡å’Œè§¦å‘æ¯”ä¾‹
   - ç‚¹å‡»ä¿å­˜é…ç½®
   - åˆ·æ–°é¡µé¢ï¼Œç¡®è®¤é…ç½®ä¿æŒä¸å˜

2. **æ—¥å¿—ä¼˜åŒ–éªŒè¯**ï¼š
   - è§‚å¯Ÿåº”ç”¨æ—¥å¿—
   - æŸ¥æ‰¾å¸¦æœ‰"Precheck:"å‰ç¼€çš„æ—¥å¿—
   - ç¡®è®¤é¢„æ£€è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¸å†æ˜¯warningçº§åˆ«

3. **ç»Ÿè®¡åŠŸèƒ½éªŒè¯**ï¼š
   - è§‚å¯Ÿé¢„æ£€ç»Ÿè®¡é¢æ¿
   - æ¨¡æ‹Ÿä¸€äº›APIè¯·æ±‚
   - ç¡®è®¤"å·²ä½¿ç”¨æœ‰æ•ˆå¯†é’¥æ•°"ä¼šæ­£ç¡®å¢åŠ 
   - ç¡®è®¤è¾¾åˆ°é˜ˆå€¼æ—¶ä¼šè§¦å‘é¢„æ£€

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### é…ç½®åŒæ­¥æœºåˆ¶
- KeyManagerå®ä¾‹å˜é‡ â†” Settingså¯¹è±¡ â†” æ•°æ®åº“
- ä¸‰å±‚åŒæ­¥ç¡®ä¿é…ç½®ä¸€è‡´æ€§
- å¼‚æ­¥ä¿å­˜é¿å…é˜»å¡ç”¨æˆ·æ“ä½œ

### æ—¥å¿—åˆ†çº§ç­–ç•¥
- `DEBUG`: è¯¦ç»†çš„å†…éƒ¨çŠ¶æ€ä¿¡æ¯
- `INFO`: é‡è¦çš„æ“ä½œå’ŒçŠ¶æ€å˜æ›´
- `WARNING`: çœŸæ­£éœ€è¦å…³æ³¨çš„é—®é¢˜
- `ERROR`: ç³»ç»Ÿé”™è¯¯å’Œå¼‚å¸¸

### é¢„æ£€è§¦å‘é€»è¾‘
- åŸºäºæœ‰æ•ˆå¯†é’¥ä½ç½®çš„ç²¾ç¡®è·Ÿè¸ª
- åŠ¨æ€é˜ˆå€¼è®¡ç®—
- æ‰¹æ¬¡åˆ‡æ¢å’Œé˜Ÿåˆ—ç®¡ç†

## ğŸ“ åç»­å»ºè®®

1. **ç›‘æ§é¢„æ£€æ•ˆæœ**ï¼š
   - è§‚å¯Ÿ429é”™è¯¯æ—¥å¿—çš„å‡å°‘æƒ…å†µ
   - ç›‘æ§é¢„æ£€ç»Ÿè®¡æ•°æ®çš„å˜åŒ–
   - åˆ†æAPIè¯·æ±‚æˆåŠŸç‡çš„æå‡

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´é¢„æ£€å‚æ•°
   - ä¼˜åŒ–é¢„æ£€å¹¶å‘æ•°å’Œé¢‘ç‡
   - è€ƒè™‘æ·»åŠ é¢„æ£€ç¼“å­˜æœºåˆ¶

3. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - æ·»åŠ é¢„æ£€çŠ¶æ€çš„å®æ—¶æ˜¾ç¤º
   - æä¾›é¢„æ£€æ•ˆæœçš„å¯è§†åŒ–å›¾è¡¨
   - å¢åŠ é¢„æ£€é…ç½®çš„æ™ºèƒ½æ¨è
